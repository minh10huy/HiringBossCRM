/*********************************************************************************
 * This file is part of KReporter. KReporter is an enhancement developed
 * by Christian Knoll. All rights are (c) 2012 by Christian Knoll
 *
 * This Version of the KReporter is licensed software and may only be used in
 * alignment with the License Agreement received with this Software.
 * This Software is copyrighted and may not be further distributed without
 * witten consent of Christian Knoll
 *
 * You can contact Christian Knoll at info@kreporter.org
 *
 ********************************************************************************/
var F=new Ext.data.JsonStore({fields:[{name:'lblid',type:'string'},{name:'value',type:'string'}]});if(document.getElementById('jsonlanguage').value!=''){var jsonLanguage;eval("jsonLanguage = "+document.getElementById('jsonlanguage').value);F.loadData(Ext.util.JSON.decode(document.getElementById('jsonlanguage').value));}var l=function(M){var recordNumber=F.find('lblid',M);if(recordNumber>=0){return F.getAt(recordNumber).data.value;}else{return M;}};function cV(){function cT(){return(((1+Math.random())*0x10000)|0).toString(16).substring(1);};return('k'+cT()+cT()+cT()+cT()+cT()+cT()+cT());};Ext.namespace('KINAMU.kreports');KINAMU.kreports.EditView=false;KINAMU.kreports.kreportsJsonStore=Ext.extend(Ext.data.JsonStore,{domElement:'',constructor:function(config){KINAMU.kreports.kreportsJsonStore.superclass.constructor.call(this,config);},loadData:function(o,append){KINAMU.kreports.kreportsJsonStore.superclass.loadData.call(this,o,append);},writeJson:function(){jArray=new Array();if(this.isFiltered()){for(i=0;i<this.snapshot.items.length;i++){jArray.push(Ext.util.JSON.encode(this.snapshot.items[i].data));}}else{for(i=0;i<this.data.items.length;i++){jArray.push(Ext.util.JSON.encode(this.data.items[i].data));}}document.getElementById(this.domElement).value='['+jArray.toString()+']';},loadDirect:function(){if(document.getElementById(this.domElement).value!='')this.loadData(Ext.util.JSON.decode(document.getElementById(this.domElement).value));},add:function(records){KINAMU.kreports.kreportsJsonStore.superclass.add.call(this,records);this.writeJson();},remove:function(record){KINAMU.kreports.kreportsJsonStore.superclass.remove.call(this,record);this.writeJson();},afterEdit:function(record){KINAMU.kreports.kreportsJsonStore.superclass.afterEdit.call(this,record);this.writeJson();},getMaxSequence:function(){var maxSequence=0;var i=0;while(i<this.getCount()){if(this.getAt(i).data.sequence>maxSequence)maxSequence=this.getAt(i).data.sequence;i++;}return parseInt(maxSequence,10);},getNextSequence:function(){cc=this.getMaxSequence()+1;if(cc<10)cc='0'+cc;return cc;}});var m=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:'index.php?module=KReports&action=get_enum&to_pdf=true'}),reader:new Ext.data.JsonReader({'fields':[{name:'value'},{name:'text'}]})});var aS=new Ext.form.ComboBox({typeAhead:true,triggerAction:'all',lazyRender:true,mode:'local',store:m,displayField:'text'});var as=[['ignore',0],['equals',1],['soundslike',1],['notequal',1],['greater',1],['greaterequal',1],['less',1],['lessequal',1],['starts',1],['notstarts',1],['contains',1],['notcontains',1],['between',2],['isempty',0],['isemptyornull',0],['isnull',0],['isnotempty',0]];var whereOperatorsId=[['equals',1],['autocomplete',1],['isempty',0],['isemptyornull',0],['isnull',0],['isnotempty',0]];var ay=[['ignore',0],['equals',1],['notequal',1],['greater',1],['greaterequal',1],['less',1],['lessequal',1],['between',2],['isempty',0],['isemptyornull',0],['isnull',0],['isnotempty',0]];var aA=[['ignore',0],['equals',1],['notequal',1],['oneof',1],['oneofnot',1],['oneofnotornull',1],['starts',1],['notstarts',1],['contains',1],['notcontains',1],['isempty',0],['isemptyornull',0],['isnull',0],['isnotempty',0]];var aB=[['ignore',0],['equals',1],['notequal',1],['before',1],['after',1],['between',2],['today',0],['past',0],['future',0],['thismonth',0],['notthismonth',0],['thisweek',0],['next3month',0],['lastmonth',0],['last3month',0],['lastndays',1],['lastnfdays',1],['lastnddays',1],['lastnweeks',1],['notlastnweeks',1],['lastnfweeks',1],['nextndays',1],['nextnddays',1],['betwndays',2],['betwnddays',2],['nextnweeks',1],['notnextnweeks',1],['thisyear',0],['lastyear',0],['tyytd',0],['lyytd',0],['isempty',0],['isemptyornull',0],['isnull',0],['isnotempty',0]];var aG=[['ignore',0],['equals',1],['notequal',1],['isemptyornull',0],['isnull',0]];var whereOperatorsFields=[{name:'operator'},{name:'values',type:'float'},{name:'display'}];var af=new Ext.data.ArrayStore({fields:whereOperatorsFields,loadArray:function(data){this.loadData(data);if(KINAMU.kreports.EditView&&document.getElementById('publishoptions').value!=''){fd=Ext.util.JSON.decode(document.getElementById('publishoptions').value);if(fd.publishSubpanelModule!=''){addPrototypeRecord=Ext.data.Record.create(whereOperatorsFields);this.add(new addPrototypeRecord({operator:'parent_assign',values:1}));}}if(KINAMU.kreports.EditView){addPrototypeRecord=Ext.data.Record.create(whereOperatorsFields);this.add(new addPrototypeRecord({operator:'function',values:1}));}if(KINAMU.kreports.EditView){addPrototypeRecord=Ext.data.Record.create(whereOperatorsFields);this.add(new addPrototypeRecord({operator:'reference',values:1}));}var V=function(record){record.set('display',l('LBL_OP_'+record.data.operator.toUpperCase()));};this.each(V);}});var av=function(ap){af.removeAll();switch(ap){case 'date':case 'datetime':case 'datetimecombo':af.loadArray(aB);break;case 'id':af.loadArray(whereOperatorsId);break;case 'relate':case 'varchar':case 'char':case 'text':case 'name':af.loadArray(as);break;case 'int':case 'double':case 'float':case 'currency':af.loadArray(ay);break;case 'bool':af.loadArray(aG);break;case 'enum':case 'multienum':case 'radioenum':case 'parent_type':case 'user_name':case 'assigned_user_name':case 'team_name':af.loadArray(aA);break;}};var aE=function(aQ,ap){av(ap);var aw=af.find('operator',aQ);if(aw>=0){return af.getAt(aw).data.values;}else{return 0;}};whereFieldGridParentFieldsStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:'index.php?module=KReports&action=get_modulefields&to_pdf=true'}),reader:new Ext.data.JsonReader({'fields':[{name:'field'},{name:'description'}]})});whereFieldGridFunctionsStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:'index.php?module=KReports&action=get_wherefunctions&to_pdf=true'}),reader:new Ext.data.JsonReader({'fields':[{name:'field'},{name:'description'}]})});whereFieldGridAutocompleteStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:'index.php?module=KReports&action=get_autocompletevalues&to_pdf=true'}),reader:new Ext.data.JsonReader({'fields':[{name:'itemid'},{name:'itemtext'}]})});var B;var J;var R;var currentEditedColumn;var whereGridLastClickXY=new Object();var aF=function(e,ag,ah){if(ag.getColumnId(e.column)=='onoffswitch'){if(e.record.data.usereditable=='yo1'||e.record.data.usereditable=='yo2'){ah.getColumnModel().setEditor(e.column,new Ext.form.ComboBox({typeAhead:true,triggerAction:'all',lazyRender:true,mode:'local',store:new Ext.data.ArrayStore({id:0,fields:['value','text'],data:[['yo1',l('LBL_ONOFF_YO1')],['yo2',l('LBL_ONOFF_YO2')]]}),displayField:'text',valueField:'value'}));}else ah.getColumnModel().setEditor(null);}if(ag.getColumnId(e.column)=='value'||ag.getColumnId(e.column)=='valueto'){var ax=aE(e.record.data.operator,e.record.data.type);if(!KINAMU.kreports.EditView){if(e.record.data.usereditable=='yo1'||e.record.data.usereditable=='yo2')ax=0;}if(ax===0||(ag.getColumnId(e.column)=='valueto'&&ax!=2)){ah.getColumnModel().setEditor(null);}else{switch(e.record.data.operator){case 'autocomplete':whereFieldGridAutocompleteStore.setBaseParam('path',e.record.data.path);fv=new Ext.form.ComboBox({store:whereFieldGridAutocompleteStore,valueField:'itemid',displayField:'itemtext',typeAhead:true,mode:'remote',triggerAction:'all',forceSelection:true,aR:true,listWidth:200});ah.getColumnModel().setEditor(e.column,fv);break;case 'parent_assign':whereFieldGridParentFieldsStore.removeAll();whereFieldGridParentFieldsStore.setBaseParam('inputmodule',Ext.util.JSON.decode(document.getElementById('publishoptions').value).publishSubpanelModule);whereFieldGridParentFieldsStore.load();eB=new Ext.form.ComboBox({store:whereFieldGridParentFieldsStore,valueField:'field',displayField:'description',typeAhead:true,mode:'local',triggerAction:'all',editable:false,aR:true,listWidth:200});ah.getColumnModel().setEditor(e.column,eB);break;case 'function':whereFieldGridFunctionsStore.removeAll();whereFieldGridFunctionsStore.load();fj=new Ext.form.ComboBox({store:whereFieldGridFunctionsStore,valueField:'field',displayField:'description',typeAhead:true,mode:'local',triggerAction:'all',editable:false,aR:true,listWidth:200});ah.getColumnModel().setEditor(e.column,fj);break;case 'reference':ah.getColumnModel().setEditor(e.column,new Ext.form.TextField());break;default:switch(e.record.data.type){case 'datetimecombo':case 'datetime':switch(e.record.data.operator){case 'lastndays':case 'lastnfdays':case 'lastnweeks':case 'notlastnweeks':case 'lastnfweeks':case 'nextndays':case 'nextnweeks':case 'notnextnweeks':case 'betwndays':ah.getColumnModel().setEditor(e.column,new Ext.form.NumberField());break;default:if(KINAMU.kreports.EditView&&(e.record.data.operator=='lastnddays'||e.record.data.operator=='nextnddays'||e.record.data.operator=='betwnddays'))ah.getColumnModel().setEditor(e.column,new Ext.form.NumberField());else{ah.getColumnModel().setEditor(e.column,new Ext.form.NumberField({}));B=e;J=ah;R=ag;currentEditedColum=ag.getColumnId(e.column);if(e.record.get(currentEditedColum)!=''){var dateArray=e.record.get(currentEditedColum).split(' ');var timeArray=dateArray[1].split(':');}else{var dateArray=['','00:00:00'];var timeArray=dateArray[1].split(':');}var thisDateField=new Ext.form.DateField({fieldLabel:l('LBL_DATETIMEPICKER_DATE'),width:130,value:dateArray[0],format:cal_date_format.replace(/%/g,'')});var thisHourField=new Ext.form.NumberField({name:'hours',xtype:'numberfield',value:timeArray[0],minValue:0,maxValue:23,allowNegative:false,listeners:{'invalid':function(){if(this.getValue()>23)this.setValue(23);if(this.getValue()<0)this.setValue(0);}},width:40});var thisMinuteField=new Ext.form.NumberField({name:'minutes',xtype:'numberfield',value:timeArray[1],minValue:0,maxValue:59,setValue:function(v){v=this.fixPrecision(v);v=Ext.isNumber(v)?v:parseFloat(String(v).replace(this.decimalSeparator,"."));v=isNaN(v)?'':String(v).replace(".",this.decimalSeparator);if(v<10)v='0'+v;return Ext.form.NumberField.superclass.setValue.call(this,v);},allowNegative:false,getTimeValue:function(){if(this.getValue()>10)return this.getValue();else return '0'+this.getValue()},listeners:{'invalid':function(){if(this.getValue()>59)this.setValue(59);if(this.getValue()<0)this.setValue(0);}},width:40});var thisSecondField=new Ext.form.NumberField({name:'seconds',xtype:'numberfield',value:timeArray[2],minValue:0,maxValue:59,allowNegative:false,setValue:function(v){v=this.fixPrecision(v);v=Ext.isNumber(v)?v:parseFloat(String(v).replace(this.decimalSeparator,"."));v=isNaN(v)?'':String(v).replace(".",this.decimalSeparator);if(v<10)v='0'+v;return Ext.form.NumberField.superclass.setValue.call(this,v);},getTimeValue:function(){if(this.getValue()>10)return this.getValue();else return '0'+this.getValue()},listeners:{'invalid':function(){if(this.getValue()>59)this.setValue(59);if(this.getValue()<0)this.setValue(0);}},width:40});var win=new Ext.Window({title:l('LBL_DATETIMEPICKER_POPUP_TITLE'),layout:'form',drggable:true,x:whereGridLastClickXY[0],y:whereGridLastClickXY[1],labelWidth:50,width:250,closeAction:'hide',draggable:true,modal:true,items:[thisDateField,{xtype:'compositefield',fieldLabel:'Time',combineErrors:false,items:[thisHourField,{xtype:'displayfield',width:3,value:':'},thisMinuteField,{xtype:'displayfield',width:3,value:':'},thisSecondField]}],buttons:[{text:l('LBL_DATETIMEPICKER_CANCEL_BUTTON'),handler:function(){win.close();}},{text:l('LBL_DATETIMEPICKER_CLOSE_BUTTON'),handler:function(){B.record.set(currentEditedColum,thisDateField.getValue().format(cal_date_format.replace(/%/g,'')+' '+thisHourField.getValue()+':'+thisMinuteField.getTimeValue()+':'+thisSecondField.getTimeValue()));B.record.set(currentEditedColum+'key',thisDateField.getValue().format('Y-m-d'+' '+thisHourField.getValue()+':'+thisMinuteField.getTimeValue()+':'+thisSecondField.getTimeValue()));J.fireEvent('afteredit',B);win.close();}}]});win.show(this);}break;}break;case 'date':switch(e.record.data.operator){case 'lastndays':case 'lastnfdays':case 'lastnweeks':case 'notlastnweeks':case 'lastnfweeks':case 'nextndays':case 'nextnweeks':case 'notnextnweeks':case 'betwndays':ah.getColumnModel().setEditor(e.column,new Ext.form.NumberField());break;case 'lastnddays':case 'nextnddays':case 'betwnddays':if(KINAMU.kreports.EditView)ah.getColumnModel().setEditor(e.column,new Ext.form.NumberField());else ah.getColumnModel().setEditor(e.column,new Ext.form.DateField({editable:false,value:e.value,format:cal_date_format.replace(/%/g,'')}));break;default:ah.getColumnModel().setEditor(e.column,new Ext.form.DateField({editable:false,format:cal_date_format.replace(/%/g,'')}));break;}break;case 'user_name':case 'assigned_user_name':case 'enum':case 'parent_type':case 'radioenum':case 'multienum':if(e.record.data.operator=='starts'||e.record.data.operator=='notstarts'||e.record.data.operator=='contains'||e.record.data.operator=='notcontains'){ah.getColumnModel().setEditor(e.column,new Ext.form.TextField());}else{m.removeAll();m.setBaseParam('path',e.record.data.path);m.load();switch(e.record.data.operator){case('oneof'):case('oneofnot'):case('oneofnotornull'):var msGridView=new Ext.grid.GridView({listeners:{'refresh':function(){var I=B.record.data.valuekey.split(',');for(var i=0;i<I.length;i++){var G=m.find('value',I[i]);if(G!= -1){at.getSelectionModel().selectRow(G,true);}}}}});var at=new Ext.grid.GridPanel({store:m,columns:[{id:'text',header:l('LBL_MULTISELECT_VALUE_HEADER'),hidden:true},{id:'value',header:l('LBL_MULTISELECT_TEXT_HEADER')}],view:msGridView,stripeRows:true,autoExpandColumn:'value',height:350,width:600});B=e;J=ah;R=ag;var win=new Ext.Window({title:l('LBL_MUTLISELECT_POPUP_TITLE'),layout:'fit',width:500,height:300,closeAction:'hide',draggable:true,modal:true,items:at,buttons:[{text:l('LBL_MUTLISELECT_CANCEL_BUTTON'),handler:function(){win.close();}},{text:l('LBL_MUTLISELECT_CLOSE_BUTTON'),handler:function(){var aa=at.getSelectionModel();var selectedRows=aa.getSelections();var newValue='';var an='';for(var i=0,O=selectedRows.length;i<O;i++){if(newValue!=''){newValue+=', ';}newValue+=selectedRows[i].data.text;if(an!=''){an+=',';}an+=selectedRows[i].data.value;}B.record.set('value',newValue);B.record.set('valuekey',an);J.fireEvent('afteredit',B);win.close();}}]});win.show(this);break;default:ah.getColumnModel().setEditor(e.column,new Ext.form.ComboBox({typeAhead:true,triggerAction:'all',lazyRender:true,mode:'local',store:m,displayField:'text',valueField:'value'}));break;}}break;case 'bool':ah.getColumnModel().setEditor(e.column,new Ext.form.ComboBox({typeAhead:true,triggerAction:'all',lazyRender:true,mode:'local',store:new Ext.data.ArrayStore({id:0,fields:['value','text'],data:[['1',l('LBL_BOOL_1')],['0',l('LBL_BOOL_0')]]}),displayField:'text',valueField:'value'}));break;default:ah.getColumnModel().setEditor(e.column,new Ext.form.TextField());break;}break;}}}if(ag.getColumnId(e.column)=='operator'){if(e.record.data.usereditable=='yes'||KINAMU.kreports.EditView){av(e.record.data.type);ah.getColumnModel().setEditor(e.column,new Ext.form.ComboBox({typeAhead:true,triggerAction:'all',lazyRender:true,mode:'local',editable:false,store:af,displayField:'display',valueField:'operator'}));}else ah.getColumnModel().setEditor(null);}};var aI=function(e,ag){if(ag.getColumnId(e.column)=='value'||ag.getColumnId(e.column)=='valueto'){switch(e.record.data.operator){case 'autocomplete':e.record.set(ag.getColumnId(e.column)+'key',e.value);e.record.set(ag.getColumnId(e.column),whereFieldGridAutocompleteStore.getAt(whereFieldGridAutocompleteStore.find('itemid',e.value)).data.itemtext);break;case 'parent_assign':e.record.set(ag.getColumnId(e.column)+'key',e.value);e.record.set(ag.getColumnId(e.column),whereFieldGridParentFieldsStore.getAt(whereFieldGridParentFieldsStore.find('field',e.value)).data.description);break;case 'function':e.record.set(ag.getColumnId(e.column)+'key',e.value);e.record.set(ag.getColumnId(e.column),whereFieldGridFunctionsStore.getAt(whereFieldGridFunctionsStore.find('field',e.value)).data.description);break;default:switch(e.record.data.type){case 'datetime':case 'datetimecombo':break;case 'date':switch(e.record.data.operator){case 'lastndays':case 'lastnfdays':case 'lastnweeks':case 'notlastnweeks':case 'lastnfweeks':case 'nextndays':case 'nextnweeks':case 'notnextnweeks':case 'betwndays':break;case 'lastnddays':case 'nextnddays':case 'betwnddays':if(!KINAMU.kreports.EditView){e.record.set(ag.getColumnId(e.column)+'key',e.value.format('Y-m-d'));e.record.set(ag.getColumnId(e.column),e.value.format(cal_date_format.replace(/%/g,'')));}break;default:e.record.set(ag.getColumnId(e.column)+'key',e.value.format('Y-m-d'));e.record.set(ag.getColumnId(e.column),e.value.format(cal_date_format.replace(/%/g,'')));break;}break;case 'user_name':case 'assigned_user_name':case 'enum':case 'radioenum':case 'parent_type':case 'multienum':switch(e.record.data.operator){case('oneof'):break;case('starts'):case('notstarts'):case('contains'):case('notcontains'):break;default:e.record.set(ag.getColumnId(e.column)+'key',e.value);e.record.set(ag.getColumnId(e.column),m.getAt(m.find('value',e.value)).data.text);break;}break;case 'bool':e.record.set(ag.getColumnId(e.column)+'key',e.value);e.record.set(ag.getColumnId(e.column),l('LBL_BOOL_'+e.value));break;default:break;}break;}}if(ag.getColumnId(e.column)=='operator'){e.record.set('value','');e.record.set('valueto','');e.record.set('valuekey','');e.record.set('valuetokey','');}};var Q='';var g=0;var C=0;var ar=new Ext.LoadMask(Ext.getBody(),{msg:"creating TargetList ... "});var bl=new Ext.LoadMask(Ext.getBody(),{msg:"geocoding Results ... "});var aq=new Ext.LoadMask(Ext.getBody(),{msg:"taking snapshot ... "});var k=new Ext.LoadMask(Ext.getBody(),{msg:"loading"});Ext.onReady(function(){Ext.Ajax.timeout=90000;if(document.getElementById('reportoptions').value!='')reportOptionsObject=Ext.util.JSON.decode(document.getElementById('reportoptions').value);else reportOptionsObject=new Object();if(document.getElementById('bingmapskey')!=null&&document.getElementById('bingmapskey').Value!=''){fO();}if(document.getElementById('geocodeEnable').value=='X')eo=false;else eo=true;var dB=function(){Ext.Ajax.request({url:'index.php?module=KReports&to_pdf=true&action=check_export_to_targetlist',success:function(response,options){if(response.responseText=='true'){Ext.getCmp('KReportsAddTargetListButton').enable();}else{Ext.getCmp('KReportsAddTargetListButton').disable();}},params:{record:document.getElementById('recordid').value}});};var dm=function(){Ext.Ajax.request({url:'index.php?module=KReports&to_pdf=true&action=check_access_level',success:function(response,options){if(response.responseText.trim()=='1'||response.responseText.trim()=='2'){Ext.getCmp('KReportsEditReportButton').enable();Ext.getCmp('KReportsDuplicateReportButton').enable();if(Ext.getCmp('KReportsLayoutSaveButton')!=undefined)Ext.getCmp('KReportsLayoutSaveButton').enable();}if(response.responseText.trim()=='2'){Ext.getCmp('KReportsDeleteReportButton').enable();}},params:{record:document.getElementById('recordid').value}});};var aO=[{name:'fieldid',mapping:'fieldid'},{name:'sequence',mapping:'sequence'},{name:'name',mapping:'name'},{name:'groupid',mapping:'groupid'},{name:'path',mapping:'path'},{name:'displaypath',mapping:'displaypath'},{name:'operator',mapping:'operator'},{name:'type',mapping:'type'},{name:'value',mapping:'value'},{name:'valuekey',mapping:'valuekey'},{name:'valueto',mapping:'valueto'},{name:'valuetokey',mapping:'valuetokey'},{name:'jointype',mapping:'jointype'},{name:'include',mapping:'include'},{name:'usereditable',mapping:'usereditable'}];var ai=new Ext.data.JsonStore({fields:aO,paramsAsHash:true,sortInfo:{field:'sequence',direction:'ASC'},listeners:{'add':function(thisItem){au();},'update':function(thisItem){au();},'remove':function(thisItem){au();}}});var D=function(store){var ae='[';function dp(record){if(ae!='['){ae+=',';}ae+=Ext.util.JSON.encode(record.data);};ai.each(dp);ae+=']';return ae;};var au=function(store){var ae='[';function dp(record){if(ae!='[')ae+=',';ae+=Ext.util.JSON.encode(record.data);};ai.each(dp);ae+=']';document.getElementById('dynamicoptions').value=ae;};if(document.getElementById('dynamicoptions').value!=''){var dynamicoptions;eval("dynamicoptions = "+document.getElementById('dynamicoptions').value);ai.loadData(dynamicoptions);var hideDynamicOperators=true;if(ai.findExact('usereditable','yes')!= -1)hideDynamicOperators=false;var hideOnOffSwitch=true;if(ai.findExact('usereditable','yo1')!= -1||ai.findExact('usereditable','yo2')!= -1)hideOnOffSwitch=false;var ag=new Ext.grid.ColumnModel([{header:l('LBL_FIELDNAME'),readOnly:true,dataIndex:'displaypath',width:150,sortable:true,hidden:true},{id:'name',header:l('LBL_NAME'),dataIndex:'name',sortable:true,width:150},{id:'onoffswitch',header:l('LBL_ONOFF_COLUMN'),readOnly:true,dataIndex:'usereditable',width:40,sortable:true,hidden:hideDynamicOperators,renderer:function(value,metaData,record,rowIndex,colIndex,store){if(value=='yo1'||value=='yo2')return l('LBL_ONOFF_'+value.toUpperCase());else return '';},editor:new Ext.form.TextField()},{id:'operator',header:l('LBL_OPERATOR'),readOnly:true,dataIndex:'operator',width:150,sortable:true,hidden:hideDynamicOperators,renderer:function(value,metaData,record,rowIndex,colIndex,store){return l('LBL_OP_'+value.toUpperCase());},editor:new Ext.form.TextField()},{id:'value',header:l('LBL_VALUE_FROM'),dataIndex:'value',sortable:true,hidden:false,width:150,editor:new Ext.form.TextField()},{id:'valueto',header:l('LBL_VALUE_TO'),dataIndex:'valueto',sortable:true,hidden:false,width:150,editor:new Ext.form.TextField()}]);if(reportOptionsObject.optionsFolded!=undefined&&reportOptionsObject.optionsFolded==false)optionsCollapsed=false;else optionsCollapsed=true;var thisTbar=function(){if(reportOptionsObject.updateOnRequest!=undefined&&reportOptionsObject.updateOnRequest==true)return[{text:l('LBL_REPORT_RELOAD'),icon:'modules/KReports/images/load_results.png',handler:function(){reloadWhereGridStore();}}];else return null;};var reloadWhereGridStore=function(){if(document.getElementById('haschart').value=='X')H();reloadReportStore(D());if(document.getElementById('bingmapskey')!=null&&document.getElementById('bingmapskey').Value!=''&&bk!='undefined'){bk.removeAll();bk.setBaseParam('whereConditions',D());bk.load();}};var ah=new Ext.grid.EditorGridPanel({store:ai,cm:ag,clicksToEdit:1,stripeRows:true,autoHeight:true,enableHdMenu:false,collapsed:optionsCollapsed,collapsible:true,renderTo:'optionsArea',title:l('LBL_DYNAMIC_OPTIONS'),tbar:thisTbar(),listeners:{'viewready':function(){ah.setHeight();},'click':function(e){whereGridLastClickXY=e.getXY();},'beforeedit':function(e){aF(e,ag,ah);},'afteredit':function(e){aI(e,ag);if(e.field=='usereditable'||e.field=='value'||e.field=='valueto'||(e.field=='operator'&&(e.value=='ignore'||e.value=='isempty'||e.value=='isemptyornull'||e.value=='isnull'||e.value=='isnotempty'||e.value=='today'||e.value=='past'||e.value=='future'||e.value=='thismonth'||e.value=='next3month'||e.value=='thisyear'||e.value=='lastmonth'||e.value=='last3month'||e.value=='lastyear'))){if(reportOptionsObject.updateOnRequest==undefined||(reportOptionsObject.updateOnRequest!=undefined&&reportOptionsObject.updateOnRequest==false))reloadWhereGridStore();}}}});};var am=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:'index.php?module=KReports&action=get_snapshots&to_pdf=true&requester='+document.getElementById('recordid').value}),reader:new Ext.data.JsonReader({'fields':[{name:'snapshot'},{name:'description'}]})});am.load();var ak=new Ext.form.ComboBox({store:am,id:'snapshot_combo',name:'snapshot_combo',displayField:'description',valueField:'snapshot',typeAhead:true,editable:false,value:'current',mode:'local',triggerAction:'all',aR:true,width:135,iconCls:'no-icon',listeners:{'select':function(){if(document.getElementById('dynamicoptions').value!=''){if(ak.value==0)ah.show();else ah.hide();}store.setBaseParam('snapshotid',ak.value);store.load();H();}}});var H=function(){Ext.Ajax.request({url:'index.php?module=KReports&to_pdf=true&action=getcharthtml',success:function(response){eval(response.responseText);},failure:function(response){document.getElementById('chartArea').innerHTML='';},params:{whereConditions:D(),record:document.getElementById('recordid').value,snapshotid:ak.value}});};var aP=function(){aq.show();Ext.Ajax.request({url:'index.php?module=KReports&to_pdf=true&action=take_snapshot',success:function(){aq.hide();am.load();},failure:function(){aq.hide();am.load();},params:{record:document.getElementById('recordid').value}});};var aC=new Ext.menu.Item({text:l('LBL_EXPORT_TO_PDFWCHART_BUTTON_LABEL'),icon:'modules/KReports/images/acrobat.png',handler:function(){reportToPdf();},disabled:true});var bH=new Ext.menu.Item({text:l('LBL_EXPORT_TO_PDF_BUTTON_LABEL'),icon:'modules/KReports/images/acrobat.png',handler:function(){aJ();},disabled:true});var az=new Ext.menu.Item({text:l('LBL_COMPARE_SNAPSHOTS_BUTTON_LABEL'),icon:'modules/KReports/images/chart_comparison.png',handler:function(){aT.show();},disabled:true});var aM=new Ext.menu.Item({text:l('LBL_BASIC_TRENDLINE_BUTTON_LABEL'),icon:'modules/KReports/images/trend_analysis.png',handler:function(){aU.show();},disabled:true});var addReportToFavorites=function(){Ext.Msg.prompt(l('LBL_FAVORITE_NAME'),l('LBL_FAVORITENAME_PROMPT'),function(f,text){if(f=='ok'){Ext.Ajax.request({url:'index.php?module=KReports&to_pdf=true&action=add_report_to_favorites',success:function(){removeFavoriteButton.show();addFavoriteButton.hide();},failure:function(){},params:{favorite_name:text,record:document.getElementById('recordid').value,whereConditions:D()}});}});};var addFavoriteButton=new Ext.Button({text:l('LBL_ADDTOFAVORITE_BUTTON_LABEL'),icon:'modules/KReports/images/add.png',handler:function(){addReportToFavorites();},hidden:true});var removeReportFromFavorites=function(){Ext.Ajax.request({url:'index.php?module=KReports&to_pdf=true&action=remove_report_from_favorites',success:function(){removeFavoriteButton.hide();addFavoriteButton.show();},failure:function(){},params:{record:document.getElementById('recordid').value}});};var removeFavoriteButton=new Ext.Button({text:l('LBL_REMOVEFAVORITE_BUTTON_LABEL'),icon:'modules/KReports/images/delete.png',handler:function(){removeReportFromFavorites();},hidden:true});var cY=function(){Ext.Ajax.request({url:'index.php?module=KReports&to_pdf=true&action=check_isfavorite',success:function(response,options){if(response.responseText=='true'){removeFavoriteButton.show();}else{addFavoriteButton.show();}},params:{record:document.getElementById('recordid').value}});};if(reportOptionsObject.showExport!=undefined&&reportOptionsObject.showExport==false)showExport=true;else showExport=false;if(reportOptionsObject.showSnapshots!=undefined&&reportOptionsObject.showSnapshots==false)showSnapshots=true;else showSnapshots=false;if(reportOptionsObject.showTools!=undefined&&reportOptionsObject.showTools==false)showTools=true;else showTools=false;var eW=false;if(document.getElementById('kreporteredition').value=='premium')eW=true;var al=new Ext.Toolbar({renderTo:'toolbarArea',items:[{text:l('LBL_EDIT_BUTTON_LABEL'),icon:'modules/KReports/images/report_edit.png',handler:function(){var form=document.getElementById('form');if(!form)var form=document.getElementById('formDetailView');form.return_module.value='KReports';form.return_action.value='DetailView';form.action.value='EditView';form.submit();},id:'KReportsEditReportButton',disabled:true},{text:l('LBL_DELETE_BUTTON_LABEL'),icon:'modules/KReports/images/report_delete.png',handler:function(){Ext.MessageBox.confirm(l('LBL_DIALOG_CONFIRM'),l('LBL_DIALOG_DELETE_YN'),function(f){if(f=='yes'){var form=document.getElementById('form');if(!form)var form=document.getElementById('formDetailView');form.return_module.value='KReports';form.return_action.value='ListView';form.action.value='Delete';form.submit();}});},id:'KReportsDeleteReportButton',disabled:true},'-',{text:l('LBL_EXPORTMENU_BUTTON_LABEL'),icon:'modules/KReports/images/export.png',disabled:showExport,menu:{items:[{text:l('LBL_EXPORT_TO_EXCEL_BUTTON_LABEL'),icon:'modules/KReports/images/excel.png',handler:function(){var form=document.getElementById('form');if(!form)var form=document.getElementById('formDetailView');form.return_module.value='KReports';form.return_action.value='DetailView';form.action.value='export_to_excel';form.dynamicoptions.value=D();form.to_pdf.value='on';if(typeof(getGridColumns)!='undefined')document.getElementById('dynamicols').value=getGridColumns();form.submit();form.to_pdf.value='';}},{text:l('LBL_EXPORT_TO_KLM_BUTTON_LABEL'),icon:'modules/KReports/images/map.png',handler:function(){exportToKML();},disabled:true},'-',bH,aC,'-',{text:l('LBL_EXPORT_TO_TARGETLIST_BUTTON_LABEL'),id:'KReportsAddTargetListButton',icon:'modules/KReports/images/targetlist.png',handler:function(){if(document.getElementById('kreporteredition').value=='premium')KINAMU.kreports.mainDetailViewTargetListExport.exportPopup.show();else Ext.Msg.prompt(l('LBL_TARGETLIST_NAME'),l('LBL_TARGETLIST_PROMPT'),function(f,text){if(f=='ok'){ar.show();Ext.Ajax.request({url:'index.php?module=KReports&to_pdf=true&action=export_to_targetlist',success:function(){ar.hide();},failure:function(){ar.hide();},params:{targetlist_name:text,record:document.getElementById('recordid').value,whereConditions:D()}});}});},disabled:true}]}},'-',{text:l('LBL_SNAPSHOTMENU_BUTTON_LABEL'),icon:'modules/KReports/images/snapshot.png',disabled:showSnapshots,menu:{items:[ak,'-',{text:l('LBL_SNAPSHOT_BUTTON_LABEL'),icon:'modules/KReports/images/snapshot.png',handler:function(){aP();}},'-',az,aM]}},'-',{text:l('LBL_TOOLSMENU_BUTTON_LABEL'),icon:'modules/KReports/images/tools.png',disabled:showTools,menu:{items:[{text:l('LBL_SCHEDULER_BUTTON'),icon:'modules/KReports/images/scheduler.png',handler:function(){fP();},disabled: !eW},{text:'massupdate',icon:'modules/KReports/images/massupdate.png',handler:function(){fU();},disabled:true},{text:l('LBL_MASS_GEOCODE_BUTTON_LABEL'),icon:'modules/KReports/images/map.png',disabled:eo,handler:function(){bl.show();Ext.Ajax.request({url:'index.php?module=KReports&to_pdf=true&action=geocode_report_results',timeout:300000,success:function(){bl.hide();bk.removeAll();bk.load();reloadReportStore(D());},failure:function(){bl.hide();bk.removeAll();bk.load();reloadReportStore(D());},params:{record:document.getElementById('recordid').value,whereConditions:D()}});}},{text:l('LBL_SQL_BUTTON_LABEL'),icon:'modules/KReports/images/sql.png',handler:function(){Ext.Ajax.request({url:'index.php?module=KReports&to_pdf=true&action=get_sql',method:'POST',success:function(response,options){win=new Ext.Window({layout:'fit',width:500,height:300,closeAction:'close',plain:true,title:l('LBL_SQL_BUTTON_LABEL'),items:new Ext.form.TextArea({value:response.responseText,readOnly:true}),buttons:[{text:'Close',handler:function(){win.close();}}]});win.show(this);},params:{record:document.getElementById('recordid').value,whereConditions:D()}});}},'-',{text:l('LBL_DUPLICATE_REPORT_BUTTON_LABEL'),id:'KReportsDuplicateReportButton',icon:'modules/KReports/images/copy.png',handler:function(){Ext.Msg.prompt(l('LBL_DUPLICATE_NAME'),l('LBL_DUPLICATE_PROMPT'),function(f,text){if(f=='ok'){Ext.Ajax.request({url:'index.php?module=KReports&to_pdf=true&action=duplicate_report',params:{newName:text,record:document.getElementById('recordid').value}});}});},disabled:true}]}},'->',{xtype:'tbtext',text:'K Reporter v2.7.7',style:{fontWeight:'bold',fontStyle:'italic'}}]});dB();dm();if(document.getElementById('kreporteredition').value=='premium')bH.enable();if(document.getElementById('haschart').value=='X'&&document.getElementById('kreporteredition').value=='premium')aC.enable();if(document.getElementById('haschart').value=='X'&&document.getElementById('kreporteredition').value=='premium')az.enable();if(document.getElementById('kreporteredition').value=='premium')aM.enable();if(document.getElementById('listtype').value=='')document.getElementById('listtype').value='standard';renderReport();var aJ=function(){var form=document.getElementById('form');if(!form)var form=document.getElementById('formDetailView');form.return_module.value='KReports';form.return_action.value='DetailView';form.action.value='export_to_pdf';document.getElementById('to_pdf').value='on';form.dynamicoptions.value=D();document.getElementById('withchart').value='no';if(store.groupField!=undefined)form.groupby.value=store.groupField;if(typeof(getGridColumns)!='undefined')document.getElementById('dynamicols').value=getGridColumns();form.submit();document.getElementById('dynamicols').value='';document.getElementById('to_pdf').value='';document.getElementById('withchart').value='no';};var exportToKML=function(){var form=document.getElementById('form');if(!form)var form=document.getElementById('formDetailView');form.return_module.value='KReports';form.return_action.value='DetailView';form.action.value='export_to_kml';form.to_pdf.value='on';form.dynamicoptions.value=D();form.submit();form.to_pdf.value='';};});var reportToPdf=function(){if(C==0){var K=document.getElementById('chart_layout').value.split('x');g=K[0]*K[1];C=1;var recordId=document.getElementById('recordid').value.replace(/-/g,'');var d=getChartFromId('kchart'+recordId+'index'+C);if(d.hasRendered())d.exportChart({exportFormat:'JPG',exportAction:'save'});}else{if(C<g){C++;var recordId=document.getElementById('recordid').value.replace(/-/g,'');var d=getChartFromId('kchart'+recordId+'index'+C);if(d.hasRendered())d.exportChart({exportFormat:'JPG',exportAction:'save'});}else{C=0;var form=document.getElementById('form');if(!form)var form=document.getElementById('formDetailView');form.return_module.value='KReports';form.return_action.value='DetailView';form.action.value='export_to_pdf';form.to_pdf.value='on';form.withchart.value='yes';if(typeof(getGridColumns)!='undefined')document.getElementById('dynamicols').value=getGridColumns();form.submit();form.to_pdf.value='';form.withchart.value='no';}}};